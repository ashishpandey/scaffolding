services:

  # traefik:
  #   container_name: traefik
  #   image: traefik:latest
  #   network_mode: bridge
  #   environment:
  #       - TZ=Asia/Shanghai
  #   ports:
  #     - '12443:443/tcp'
  #     - '80:80/tcp'
  #     - '81:8080/tcp'
  #   volumes:
  #     - '/mnt/cache/appdata/traefik:/etc/traefik:rw'
  #     - '/var/run/docker.sock:/var/run/docker.sock:ro'
  #   labels:
  #     traefik.enable: true
  #     traefik.http.routers.api.rule: Host(`app.apandey.com`)
  #     traefik.http.routers.api.entryPoints: http
  #     traefik.http.routers.api.service: api@internal
  wud:
    container_name: wud
    image: getwud/wud:latest
    network_mode: bridge
    environment:
      TZ: Asia/Hong_Kong
      PGID: '100'
      PUID: '99'
      WUD_WATCHER_LOCAL_CRON: 0 1 * * *
      WUD_WATCHER_LOCAL_WATCHALL: 'false'
      WUD_WATCHER_LOCAL_WATCHATSTART: 'false'
      WUD_WATCHER_LOCAL_WATCHEVENTS: 'false'
      WUD_REGISTRY_HUB_PUBLIC_LOGIN: "$DOCKER_HUB_USERNAME"
      WUD_REGISTRY_HUB_PUBLIC_PASSWORD: "$DOCKER_HUB_API_KEY"
      WUD_REGISTRY_LSCR_LSCR_USERNAME: ashishpandey
      WUD_REGISTRY_LSCR_LSCR_TOKEN: "$WUD_GITHUB_TOKEN"
      WUD_TRIGGER_DISCORD_1_URL: "$WUD_DISCORD_WEBHOOK"
      WUD_TRIGGER_DISCORD_1_BOTUSERNAME: WUD@Godaam
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock'
      - '/mnt/cache/appdata/wud:/store'
    labels:
      traefik.enable: true
      traefik.http.services.wud.loadbalancer.server.port: '3000'
      traefik.http.routers.wud.rule: 'Host(`wud.app.apandey.com`)'

  actual_server:
    container_name: actual
    hostname: actual-server
    network_mode: bridge
    image: actualbudget/actual-server:latest
    ports:
      - '5006:5006'
    environment:
      - ACTUAL_PORT=5006
      - ACTUAL_UPLOAD_FILE_SYNC_SIZE_LIMIT_MB=20
      - ACTUAL_UPLOAD_SYNC_ENCRYPTED_FILE_SYNC_SIZE_LIMIT_MB=50
      - ACTUAL_UPLOAD_FILE_SIZE_LIMIT_MB=20
      # See all options and more details at https://actualbudget.github.io/docs/Installing/Configuration
    volumes:
      - /mnt/user/appdata/actual-server:/data
    restart: always
    labels:
      traefik.enable: true
      traefik.http.services.actual-server.loadbalancer.server.port: '5006'
      traefik.http.routers.actual-server.rule: 'Host(`actual.app.apandey.com`)'

  nextcloud-db:
    container_name: nextcloud-db
    image: lscr.io/linuxserver/mariadb
    network_mode: bridge
    environment:
      TZ: Asia/Shanghai
      MYSQL_ROOT_PASSWORD: ${NEXTCLOUD_DB_ROOT_PASS}
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_PASSWORD: ${NEXTCLOUD_DB_PASS}
      PUID: '99'
      PGID: '100'
      UMASK: '022'
    ports:
      - '3306:3306/tcp'
    volumes:
      - '/mnt/user/appdata/mariadb:/config:rw'
    
  nextcloud:
    container_name: nextcloud
    image: lscr.io/linuxserver/nextcloud:32.0.3
    network_mode: bridge
    environment:
      TZ: Asia/Shanghai
      PUID: '99'
      PGID: '100'
      UMASK: '022'
    ports:
      - '3443:443/tcp'
    volumes:
      - '/mnt/user/nextcloud/:/data:rw'
      - '/mnt/user/appdata/nextcloud:/config:rw'
    labels:
      wud.tag.include: ^\d+\.\d+\.\d+$$

  paperless-redis:
    container_name: paperless_redis
    image: redis
    network_mode: bridge
    environment:
      TZ: Asia/Shanghai
    ports:
      - '6379:6379/tcp'

  paperless-ngx:
    container_name: paperless-ngx
    image: ghcr.io/paperless-ngx/paperless-ngx
    network_mode: bridge
    environment:
      TZ: Asia/Shanghai
      PAPERLESS_REDIS: redis://192.168.1.215:6379
      PAPERLESS_OCR_LANGUAGE: eng
      PAPERLESS_OCR_LANGUAGES: ""
      PAPERLESS_FILENAME_FORMAT: "{created}-{correspondent}-{title}"
      PAPERLESS_TIME_ZONE: Asia/Hong_Kong
      PAPERLESS_IGNORE_DATES: ""
      PAPERLESS_CONSUMER_POLLING: "0"
      PAPERLESS_SECRET_KEY: "${PAPERLESS_SECRET_KEY}"
      USERMAP_UID: "99"
      USERMAP_GID: "100"
    ports:
      - '8000:8000/tcp'
    volumes:
      - '/mnt/user/appdata/paperless-ngx/data:/usr/src/paperless/data:rw'
      - '/mnt/user/appdata/paperless-ngx/media:/usr/src/paperless/media:rw'
      - '/mnt/user/appdata/paperless-ngx/consume:/usr/src/paperless/consume:rw'
      - '/mnt/user/appdata/paperless-ngx/export:/usr/src/paperless/export:rw'
      
      
  vaultwarden:
    container_name: vaultwarden
    image: vaultwarden/server
    network_mode: bridge
    environment:
      TZ: Asia/Shanghai
      HOST_CONTAINERNAME: vaultwarden
      SIGNUPS_ALLOWED: true
      INVITATIONS_ALLOWED: true
      WEBSOCKET_ENABLED: false
      ADMIN_TOKEN: "${VAULT_ADMIN_TOKEN}"
    ports:
        - '4743:80/tcp'
    volumes:
        - '/mnt/user/appdata/vaultwarden:/data:rw'

  endurain:
    container_name: endurain-app
    image: ghcr.io/joaovitoriasilva/endurain:latest
    # network_mode: bridge
    networks: 
      - app_bridge
    volumes:
      # - /mnt/user/appdata/endurain/frontend/dist/env.js:/app/frontend/dist/env.js # necessary to configure the frontend with public URL
    #  - <local_path>/endurain/backend/app:/app/backend # Configure volume if you want to edit the code locally by cloning the repo
      - /mnt/user/appdata/endurain/backend/data:/app/backend/data # necessary for activity files, user images and server images persistence on container image updates
      - /mnt/user/appdata/endurain/backend/logs:/app/backend/logs # log files for the backend
    environment:
      TZ: Asia/Hong_Kong
      UID: '99'
      GID: '100'
      UMASK: '022'
      DB_PASSWORD: ${ENDURAIN_DB_PASS}
      DB_DATABASE: endurain
      DB_USER: endurain
      DB_HOST: endurain-db
      SECRET_KEY: ${ENDURAIN_SECRET_KEY}
      FERNET_KEY: ${ENDURAIN_FERNET_KEY}
      ENDURAIN_HOST: https://endurain.app.apandey.com
      BEHIND_PROXY: true
      # Email configuration (for password reset functionality)
      #SMTP_HOST=smtp.protonmail.ch
      #SMTP_PORT=587
      #SMTP_USERNAME=your-email@example.com
      #SMTP_PASSWORD=your-app-password
      #SMTP_SECURE=true
      #SMTP_SECURE_TYPE=starttls
    ports:
      - 38080:8080
    depends_on:
      endurain-db:
        condition: service_healthy
    labels:
      traefik.enable: true
      traefik.http.services.endurain.loadbalancer.server.port: '8080'
      traefik.http.routers.endurain.rule: 'Host(`endurain.app.apandey.com`)'
      trafeik.docker.network: app_bridge

  endurain-db:
    image: docker.io/postgres:17.7
    container_name: endurain-db
    networks: 
      - app_bridge
    user: '99:100'
    environment:
      TZ: Asia/Hong_Kong
      PUID: '99'
      PGID: '100'
      UMASK: '022'
      POSTGRES_PASSWORD: ${ENDURAIN_DB_PASS}
      POSTGRES_DB: endurain
      POSTGRES_USER: endurain
      PGDATA: /var/lib/postgresql/data/pgdata
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U endurain"]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - /mnt/user/appdata/endurain/postgres:/var/lib/postgresql/data
    labels:
      wud.tag.include: ^17\.\d+$$

  withings-sync:
    image: ghcr.io/jaroslawhartman/withings-sync:latest
    container_name: withings-sync
    environment:
      TZ: Asia/Hong_Kong
      PUID: '99'
      PGID: '100'
      UMASK: '022'
      GARMIN_USERNAME: ${GARMIN_USERNAME}
      GARMIN_PASSWORD: ${GARMIN_PASSWORD}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /mnt/user/appdata/withings-sync:/config
    entrypoint: 
      - /bin/sh
      - -c
      - |
        echo "5 50 */4 * * * * poetry run withings-sync --config-folder /config" > /home/withings-sync/cronjob
        supercronic -debug -passthrough-logs /home/withings-sync/cronjob
    restart: unless-stopped

  frigate:
    container_name: frigate
    network_mode: bridge
    restart: unless-stopped
    image: ghcr.io/blakeblackshear/frigate:stable-tensorrt
    environment:
      NVIDIA_VISIBLE_DEVICES: GPU-6ef3c871-0136-0942-8509-60c53293b64d
      NVIDIA_DRIVER_CAPABILITIES: all
      YOLO_MODELS: yolov7-320
    shm_size: 1g
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    volumes:
      - /mnt/user/appdata/frigate:/config
      - /mnt/tsdb/tsdata/frigate/storage:/media/frigate
      - type: tmpfs # Optional: 1GB of memory, reduces SSD/SD Card wear
        target: /tmp/cache
        tmpfs:
          size: 1000000000
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "8971:8971"
      - "8554:8554" # RTSP feeds
      - "8555:8555/tcp" # WebRTC
      - "8555:8555/udp" # WebRTC
      - "1984:1984" # go2rtc
    labels:
      traefik.enable: true
      traefik.http.services.frigate.loadbalancer.server.port: '8971'
      traefik.http.routers.frigate.rule: 'Host(`frigate.app.apandey.com`)'

networks:
  app_bridge:
    name: app_bridge
    external: true
      
